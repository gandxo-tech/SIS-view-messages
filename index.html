<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>SIS-Voir les messages</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* VARIABLES CSS POUR LES MODES */
    :root {
      /* Couleurs du mode clair (par d√©faut) */
      --body-bg: #f6fbfd;
      --container-bg: #fff;
      --text-color: #333333;
      --accent-color: #0072b5; /* Bleu principal */
      --secondary-accent-color: #1cc7e4;
      --accent-hover: #0056b3;
      --input-bg: #ffffff;
      --input-border: #1cc7e4;
      --msg-item-bg: #e5f9fc;
      --msg-item-hover-shadow: #1cc7e466;
      --no-msg-color: #d61616;
      --shadow-color: #2a5ea4;
      --download-btn-bg: #00bfff;
      --download-btn-hover: #0099cc;
    }

    /* Couleurs du mode sombre */
    body.dark-mode {
      --body-bg: #121822;
      --container-bg: #1a222c;
      --text-color: #f0f0f0;
      --accent-color: #5d9cec;
      --secondary-accent-color: #00fff7;
      --accent-hover: #4a80d4;
      --input-bg: #283340;
      --input-border: #303a4b;
      --msg-item-bg: #3a4755;
      --msg-item-hover-shadow: #00fff766;
      --no-msg-color: #ff8888;
      --shadow-color: #00fff7;
      --download-btn-bg: #00fff7;
      --download-btn-hover: #00b6b6;
    }

    /* Style g√©n√©ral */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--body-bg);
      color: var(--text-color);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transition: background 0.5s, color 0.5s;
    }
    
    .mode-toggle-container {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      align-items: center;
    }
    .mode-label {
      font-size: 0.9em;
      margin: 0 8px;
    }

    .container {
      margin: 2vh auto;
      background: var(--container-bg);
      padding: 32px 20px;
      border-radius: 32px;
      width: 96vw;
      max-width: 440px;
      box-shadow: 0 8px 2px var(--shadow-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background-color 0.5s, box-shadow 0.5s;
    }
    h2 { color: var(--accent-color); margin-top: 0; }
    input[type="text"] {
      width: 80%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--input-border);
      background-color: var(--input-bg);
      color: var(--text-color);
      margin-bottom: 10px;
      font-size: 17px;
      text-align: center;
      transition: background-color 0.5s, border-color 0.5s, color 0.5s;
    }
    button {
      background: var(--secondary-accent-color);
      color: var(--container-bg);
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin-bottom: 18px;
      align-self: center;
      transition: background 0.2s;
    }
    button:hover { background: var(--accent-hover); }
    .msg-list { margin-top: 22px; width: 100%; }
    .msg-item {
      background: var(--msg-item-bg);
      margin-bottom: 28px;
      padding: 18px;
      border-radius: 14px;
      box-shadow: 0 1px 6px var(--msg-item-hover-shadow);
      color: var(--text-color);
      position: relative;
      border-left: 5px solid var(--secondary-accent-color);
      transition: box-shadow 0.2s, background-color 0.5s, border-color 0.5s;
      width: 100%;
      box-sizing: border-box;
    }
    .msg-item:hover {
      box-shadow: 0 4px 20px var(--msg-item-hover-shadow);
    }
    .msg-date {
      color: var(--secondary-accent-color);
      font-size: 13px;
      margin-top: 10px;
      text-align: right;
    }
    .no-msg {
      color: var(--no-msg-color);
      margin-top: 30px;
      text-align: center;
    }
    .download-msg-btn {
      margin-top: 12px;
      background: var(--download-btn-bg);
      color: var(--container-bg);
      border: none;
      border-radius: 8px;
      font-size: 13px;
      padding: 6px 12px;
      cursor: pointer;
      float: right;
      transition: background 0.2s;
    }
    .download-msg-btn:hover {
      background: var(--download-btn-hover);
    }
    /* Styles pour l'interrupteur */
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 28px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--input-border);
      transition: .4s;
      border-radius: 28px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: var(--secondary-accent-color);
    }
    input:checked + .slider:before {
      transform: translateX(22px);
    }

    /* Responsive Mobile */
    @media (max-width: 600px) {
      .container {
        padding: 16px 6px;
        border-radius: 18px;
        width: 98vw;
        max-width: 96vw;
      }
      input[type="text"] {
        font-size: 15px;
        padding: 8px;
      }
      button {
        font-size: 15px;
        padding: 8px 10px;
      }
      .msg-item {
        padding: 12px 10px 8px 10px;
        border-radius: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="mode-toggle-container">
    <span class="mode-label">Clair</span>
    <label class="switch">
      <input type="checkbox" id="mode-toggle-checkbox">
      <span class="slider"></span>
    </label>
    <span class="mode-label">Sombre</span>
  </div>
  <div class="container">
    <h2>üì¨ Mes messages re√ßus</h2>
    <input type="text" id="pseudo" placeholder="Ton pseudo exact">
    <button id="voirBtn">Voir mes messages</button>
    <div class="msg-list" id="msgList"></div>
  </div>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-97TCHJ33KW"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){ dataLayer.push(arguments); }

  gtag('js', new Date());
  gtag('config', 'G-97TCHJ33KW', {
    page_path: window.location.pathname + window.location.search,
    page_location: window.location.href
  });

  // Identifier ce site dans GA
  gtag('event', 'site_loaded', {
    site_name: 'sis-view-messages'
  });
</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBqk3L_qkolD41H3yvHEzz4O-Sr15I-Tko",
      authDomain: "gandxoanonymous.firebaseapp.com",
      projectId: "gandxoanonymous",
      storageBucket: "gandxoanonymous.appspot.com",
      messagingSenderId: "836606625364",
      appId: "1:836606625364:web:7150571998131c41c0cfc1",
      measurementId: "G-97TCHJ33KW"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    document.getElementById('voirBtn').onclick = async () => {
      const pseudo = document.getElementById('pseudo').value.trim();
      const msgList = document.getElementById('msgList');
      msgList.innerHTML = "";

      if (!pseudo) {
        alert("Entre ton pseudo !");
        return;
      }

      try {
        const q = query(
          collection(db, "messages"),
          where("to", "==", pseudo),
          orderBy("createdAt", "desc")
        );
        const snap = await getDocs(q);

        if (snap.empty) {
          msgList.innerHTML = `<div class="no-msg">Aucun message re√ßu pour ce pseudo...üôÖ‚Äç‚ôÇÔ∏èü§∑‚Äç‚ôÇÔ∏è</div>`;
        } else {
          snap.forEach(doc => {
            const d = doc.data();
            let dateTxt = "";
            if (d.createdAt && d.createdAt.toDate) {
              dateTxt = d.createdAt.toDate().toLocaleString();
            }
            const divId = `msg-${doc.id}`;
            msgList.innerHTML += `
              <div class="msg-item" id="${divId}">
                <div>${d.message}</div>
                <div class="msg-date">${dateTxt}</div>
                <button class="download-msg-btn" data-msgid="${divId}">T√©l√©charger ce message (image)</button>
              </div>
            `;
          });

          // Ajout du handler pour chaque bouton de t√©l√©chargement
          setTimeout(() => {
            document.querySelectorAll('.download-msg-btn').forEach(btn => {
              btn.onclick = async function() {
                const msgDiv = document.getElementById(btn.dataset.msgid);
                html2canvas(msgDiv).then(canvas => {
                  const link = document.createElement('a');
                  link.href = canvas.toDataURL("image/png");
                  link.download = "messageSIS.png";
                  link.click();
                });
              }
            });
          }, 100);
        }
      } catch (e) {
        msgList.innerHTML = `<div class="no-msg">Erreur : ${e.message}</div>`;
      }
    };
  </script>
  <script>
    // G√®re la bascule entre le mode clair et le mode sombre
    document.addEventListener('DOMContentLoaded', function() {
      const modeToggle = document.getElementById('mode-toggle-checkbox');
      const body = document.body;

      // Fonction pour appliquer le mode
      function applyMode(isDarkMode) {
        if (isDarkMode) {
          body.classList.add('dark-mode');
        } else {
          body.classList.remove('dark-mode');
        }
      }

      // Charger la pr√©f√©rence de l'utilisateur
      const savedMode = localStorage.getItem('mode');
      if (savedMode === 'dark') {
        modeToggle.checked = true;
        applyMode(true);
      } else {
        applyMode(false);
      }

      // √âcouter le changement sur le s√©lecteur
      modeToggle.addEventListener('change', () => {
        if (modeToggle.checked) {
          localStorage.setItem('mode', 'dark');
          applyMode(true);
        } else {
          localStorage.setItem('mode', 'light');
          applyMode(false);
        }
      });
    });

    // D√©sactive le clic droit
    document.addEventListener('contextmenu', function(e) {
      e.preventDefault();
      alert("Fonction d√©sactiv√©e üö´");
    });

    // D√©sactive F12, Ctrl+U, Ctrl+Shift+I/J/C, Ctrl+S‚Ä¶
    document.addEventListener('keydown', function(e) {
      if (
        e.key === "F12" ||
        (e.ctrlKey && e.key.toLowerCase() === 'u') ||
        (e.ctrlKey && e.shiftKey && ['i', 'j', 'c'].includes(e.key.toLowerCase())) ||
        (e.ctrlKey && e.key.toLowerCase() === 's')
      ) {
        e.preventDefault();
        alert("Action interdite üö´");
      }
    });
  </script>
</body>
</html>